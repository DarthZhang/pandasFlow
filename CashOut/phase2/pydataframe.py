
# coding: utf-8

# In[68]:


import pandas as pd 
from sklearn.metrics import confusion_matrix
from sklearn.ensemble import RandomForestClassifier 
from sklearn.utils import shuffle  
from sklearn.cross_validation import train_test_split
from pyspark  import SparkConf, SparkContext
#sc.stop()
 
conf1 = SparkConf().setAppName("New App")
#conf1.set("spark.kryoserializer.buffer","1500m")
conf1.set("spark.driver.maxResultSize", "2g") 
conf1.set("spark.executor.memory", "4g")
conf1.set("spark.kryoserializer.buffer.max","1500m")
sc = SparkContext(conf=conf1)
 


# In[62]:

#raw_rdd = sc.textFile("hdfs:///user/hdanaly/xrli/IntelDNN/Weika/FE_db_08new.csv")
raw_rdd = sc.textFile("hdfs:///user/hdanaly/xrli/IntelDNN/Weika/FE_db_08.csv")
#raw_rdd = sc.textFile("hdfs:///user/hdanaly/xrli/IntelDNN/Weika/201608_new/FE_db_csv")
raw_rdd = raw_rdd.map(lambda line:line.split(","))

raw_rdd.first()
from pyspark.sql.types import *

schema = StructType([StructField("pri_acct_no_conv", StringType(), True), StructField("label", StringType(), True), StructField("cur_cross_dist_cnt_db", StringType(), True), StructField("day7_tot_amt_db", StringType(), True), StructField("is_MC_changed_db", StringType(), True), StructField("money_near_last_db", StringType(), True), StructField("tot_locs_db", StringType(), True), StructField("auth_id_resp_cd_db", StringType(), True), StructField("term_id_db", StringType(), True), StructField("min5_highrisk_loc_cnt_db", StringType(), True), StructField("mcnt_locs_db", StringType(), True), StructField("timestamp_in_min_db", StringType(), True), StructField("day30_tot_amt_db", StringType(), True), StructField("day3_fcnt_term_db", StringType(), True), StructField("day3_max_amt_db", StringType(), True), StructField("min120_failure_cnt_db", StringType(), True), StructField("min120_min_amt_db", StringType(), True), StructField("is_highrisk_MC_db", StringType(), True), StructField("min120_avg_amt_db", StringType(), True), StructField("hist_max_amt_db", StringType(), True), StructField("day_week_db", StringType(), True), StructField("day7_fraud_cnt_db", StringType(), True), StructField("day7_min_amt_db", StringType(), True), StructField("row_trans_db", StringType(), True), StructField("hist_fraud_cnt_db", StringType(), True), StructField("RMB_db", StringType(), True), StructField("min15_highrisk_MCC_cnt_db", StringType(), True), StructField("hist_highrisk_loc_cnt_db", StringType(), True), StructField("day30_highrisk_MCC_cnt_db", StringType(), True), StructField("day3_tot_amt_db", StringType(), True), StructField("min5_tot_cnt_db", StringType(), True), StructField("day7_freq_cnt_db", StringType(), True), StructField("day3_freq_cnt_db", StringType(), True), StructField("day3_min_amt_db", StringType(), True), StructField("min5_query_cnt_db", StringType(), True), StructField("loc_day30_cnt_db", StringType(), True), StructField("tfr_dt_tm_db", StringType(), True), StructField("min15_tot_amt_db", StringType(), True), StructField("day7_tot_cnt_db", StringType(), True), StructField("day30_fcnt_term_db", StringType(), True), StructField("hist_min_amt_db", StringType(), True), StructField("day7_highrisk_MCC_cnt_db", StringType(), True), StructField("cur_tot_locs_db", StringType(), True), StructField("min120_highrisk_loc_cnt_db", StringType(), True), StructField("min15_highrisk_loc_cnt_db", StringType(), True), StructField("quant_interval_1_db", StringType(), True), StructField("cur_highrisk_loc_cnt_db", StringType(), True), StructField("day7_no_trans_db", StringType(), True), StructField("cur_success_cnt_db", StringType(), True), StructField("min15_cross_dist_cnt_db", StringType(), True), StructField("cur_query_cnt_db", StringType(), True), StructField("money_eq_last_db", StringType(), True), StructField("hist_failure_cnt_db", StringType(), True), StructField("min15_query_cnt_db", StringType(), True), StructField("total_disc_at_db", StringType(), True), StructField("hist_avg_interval_db", StringType(), True), StructField("min120_cross_dist_cnt_db", StringType(), True), StructField("min15_min_amt_db", StringType(), True), StructField("interval_minutes_1_db", StringType(), True), StructField("last_mone_1_db", StringType(), True), StructField("cur_tot_provs_db", StringType(), True), StructField("day7_fcnt_mchnt_db", StringType(), True), StructField("cur_min_amt_db", StringType(), True), StructField("min15_avg_amt_db", StringType(), True), StructField("cur_avg_interval_db", StringType(), True), StructField("rcv_settle_at_db", StringType(), True), StructField("min5_max_amt_db", StringType(), True), StructField("hist_highrisk_MCC_cnt_db", StringType(), True), StructField("is_loc_changed_db", StringType(), True), StructField("min120_tot_cnt_db", StringType(), True), StructField("hist_query_cnt_db", StringType(), True), StructField("min120_no_trans_db", StringType(), True), StructField("day3_tot_cnt_db", StringType(), True), StructField("day3_highrisk_loc_cnt_db", StringType(), True), StructField("tot_provs_db", StringType(), True), StructField("day30_no_trans_db", StringType(), True), StructField("hist_success_cnt_db", StringType(), True), StructField("cur_tot_amt_db", StringType(), True), StructField("day30_fcnt_mchnt_db", StringType(), True), StructField("interval_money_1_db", StringType(), True), StructField("hist_cross_dist_cnt_db", StringType(), True), StructField("mcnt_provs_db", StringType(), True), StructField("min120_highrisk_MCC_cnt_db", StringType(), True), StructField("min15_success_cnt_db", StringType(), True), StructField("min15_failure_cnt_db", StringType(), True), StructField("trans_at_db", StringType(), True), StructField("hour_db", StringType(), True), StructField("day7_avg_interval_db", StringType(), True), StructField("day30_success_cnt_db", StringType(), True), StructField("min5_min_amt_db", StringType(), True), StructField("day7_max_amt_db", StringType(), True), StructField("day30_fraud_cnt_db", StringType(), True), StructField("is_bigRMB_1000_db", StringType(), True), StructField("day3_success_cnt_db", StringType(), True), StructField("cur_failure_cnt_db", StringType(), True), StructField("is_highrisk_MCC_db", StringType(), True), StructField("cur_highrisk_MCC_cnt_db", StringType(), True), StructField("min120_max_amt_db", StringType(), True), StructField("day30_avg_interval_db", StringType(), True), StructField("day3_cross_dist_cnt_db", StringType(), True), StructField("cardholder_fail_db", StringType(), True), StructField("day3_fraud_cnt_db", StringType(), True), StructField("is_bigRMB_500_db", StringType(), True), StructField("min5_failure_cnt_db", StringType(), True), StructField("is_PW_need_db", StringType(), True), StructField("day3_failure_cnt_db", StringType(), True), StructField("is_lowrisk_MCC_db", StringType(), True), StructField("is_frequent_provs_db", StringType(), True), StructField("min120_query_cnt_db", StringType(), True), StructField("day7_fcnt_term_db", StringType(), True), StructField("RMB_bits_db", StringType(), True), StructField("date_db", StringType(), True), StructField("hist_avg_amt_db", StringType(), True), StructField("min120_tot_amt_db", StringType(), True), StructField("day30_avg_amt_db", StringType(), True), StructField("cur_max_amt_db", StringType(), True), StructField("day30_min_amt_db", StringType(), True), StructField("day30_highrisk_loc_cnt_db", StringType(), True), StructField("day7_avg_amt_db", StringType(), True), StructField("day7_failure_cnt_db", StringType(), True), StructField("min15_tot_cnt_db", StringType(), True), StructField("is_freq_loc_highrisk_db", StringType(), True), StructField("loc_day7_cnt_db", StringType(), True), StructField("min5_success_cnt_db", StringType(), True), StructField("loc_day3_cnt_db", StringType(), True), StructField("min5_cross_dist_cnt_db", StringType(), True), StructField("day30_cross_dist_cnt_db", StringType(), True), StructField("day7_query_cnt_db", StringType(), True), StructField("is_spec_airc_db", StringType(), True), StructField("is_success_db", StringType(), True), StructField("min5_highrisk_MCC_cnt_db", StringType(), True), StructField("min120_success_cnt_db", StringType(), True), StructField("day30_freq_cnt_db", StringType(), True), StructField("cur_tot_cnt_db", StringType(), True), StructField("min5_tot_amt_db", StringType(), True), StructField("day7_cross_dist_cnt_db", StringType(), True), StructField("is_norm_rate_db", StringType(), True), StructField("day30_tot_cnt_db", StringType(), True), StructField("hist_freq_cnt_db", StringType(), True), StructField("is_frequent_locs_db", StringType(), True), StructField("min15_no_trans_db", StringType(), True), StructField("no_auth_id_resp_cd_db", StringType(), True), StructField("day3_highrisk_MCC_cnt_db", StringType(), True), StructField("is_highrisk_loc_db", StringType(), True), StructField("day30_failure_cnt_db", StringType(), True), StructField("hist_no_trans_db", StringType(), True), StructField("is_Night_db", StringType(), True), StructField("day3_no_trans_db", StringType(), True), StructField("day3_query_cnt_db", StringType(), True), StructField("day7_highrisk_loc_cnt_db", StringType(), True), StructField("min15_max_amt_db", StringType(), True), StructField("cur_freq_cnt_db", StringType(), True), StructField("mchnt_cd_db", StringType(), True), StructField("is_large_integer_db", StringType(), True), StructField("hist_tot_cnt_db", StringType(), True), StructField("day3_avg_amt_db", StringType(), True), StructField("min5_avg_amt_db", StringType(), True), StructField("min5_no_trans_db", StringType(), True), StructField("cur_avg_amt_db", StringType(), True), StructField("hist_tot_amt_db", StringType(), True), StructField("day3_fcnt_mchnt_db", StringType(), True), StructField("count_89_db", StringType(), True), StructField("day30_max_amt_db", StringType(), True), StructField("day30_query_cnt_db", StringType(), True), StructField("day3_avg_interval_db", StringType(), True), StructField("day7_success_cnt_db", StringType(), True), StructField("settle_tp_idx_db", StringType(), True), StructField("settle_cycle_idx_db", StringType(), True), StructField("block_id_idx_db", StringType(), True), StructField("trans_fwd_st_idx_db", StringType(), True), StructField("trans_rcv_st_idx_db", StringType(), True), StructField("sms_dms_conv_in_idx_db", StringType(), True), StructField("cross_dist_in_idx_db", StringType(), True), StructField("tfr_in_in_idx_db", StringType(), True), StructField("trans_md_idx_db", StringType(), True), StructField("source_region_cd_idx_db", StringType(), True), StructField("dest_region_cd_idx_db", StringType(), True), StructField("cups_card_in_idx_db", StringType(), True), StructField("cups_sig_card_in_idx_db", StringType(), True), StructField("card_class_idx_db", StringType(), True), StructField("card_attr_idx_db", StringType(), True), StructField("acq_ins_tp_idx_db", StringType(), True), StructField("fwd_ins_tp_idx_db", StringType(), True), StructField("rcv_ins_tp_idx_db", StringType(), True), StructField("iss_ins_tp_idx_db", StringType(), True), StructField("acpt_ins_tp_idx_db", StringType(), True), StructField("resp_cd1_idx_db", StringType(), True), StructField("resp_cd2_idx_db", StringType(), True), StructField("resp_cd3_idx_db", StringType(), True), StructField("resp_cd4_idx_db", StringType(), True), StructField("cu_trans_st_idx_db", StringType(), True), StructField("sti_takeout_in_idx_db", StringType(), True), StructField("trans_id_idx_db", StringType(), True), StructField("trans_tp_idx_db", StringType(), True), StructField("trans_chnl_idx_db", StringType(), True), StructField("card_media_idx_db", StringType(), True), StructField("trans_id_conv_idx_db", StringType(), True), StructField("trans_curr_cd_idx_db", StringType(), True), StructField("conn_md_idx_db", StringType(), True), StructField("msg_tp_idx_db", StringType(), True), StructField("msg_tp_conv_idx_db", StringType(), True), StructField("trans_proc_cd_idx_db", StringType(), True), StructField("trans_proc_cd_conv_idx_db", StringType(), True), StructField("mchnt_tp_idx_db", StringType(), True), StructField("pos_entry_md_cd_idx_db", StringType(), True), StructField("pos_cond_cd_idx_db", StringType(), True), StructField("pos_cond_cd_conv_idx_db", StringType(), True), StructField("term_tp_idx_db", StringType(), True), StructField("rsn_cd_idx_db", StringType(), True), StructField("addn_pos_inf_idx_db", StringType(), True), StructField("iss_ds_settle_in_idx_db", StringType(), True), StructField("acq_ds_settle_in_idx_db", StringType(), True), StructField("upd_in_idx_db", StringType(), True), StructField("pri_cycle_no_idx_db", StringType(), True), StructField("disc_in_idx_db", StringType(), True), StructField("fwd_settle_conv_rt_idx_db", StringType(), True), StructField("rcv_settle_conv_rt_idx_db", StringType(), True), StructField("fwd_settle_curr_cd_idx_db", StringType(), True), StructField("rcv_settle_curr_cd_idx_db", StringType(), True), StructField("acq_ins_id_cd_BK_idx_db", StringType(), True), StructField("acq_ins_id_cd_RG_idx_db", StringType(), True), StructField("fwd_ins_id_cd_BK_idx_db", StringType(), True), StructField("fwd_ins_id_cd_RG_idx_db", StringType(), True), StructField("rcv_ins_id_cd_BK_idx_db", StringType(), True), StructField("rcv_ins_id_cd_RG_idx_db", StringType(), True), StructField("iss_ins_id_cd_BK_idx_db", StringType(), True), StructField("iss_ins_id_cd_RG_idx_db", StringType(), True), StructField("acpt_ins_id_cd_BK_idx_db", StringType(), True), StructField("acpt_ins_id_cd_RG_idx_db", StringType(), True), StructField("settle_fwd_ins_id_cd_BK_idx_db", StringType(), True), StructField("settle_fwd_ins_id_cd_RG_idx_db", StringType(), True), StructField("settle_rcv_ins_id_cd_BK_idx_db", StringType(), True), StructField("settle_rcv_ins_id_cd_RG_idx_db", StringType(), True)])

from pyspark.sql import SQLContext
sqlContext = SQLContext(sc)

sparkDF = sqlContext.createDataFrame(raw_rdd, schema)

#sparkDF = sparkDF.sample(False,0.0001)
print "sparkDF done"


# In[59]:

df_All = sparkDF.toPandas()
#print df_All 
print "to pandas done"


# In[60]:

print "All done"


# In[ ]:




# In[ ]:



